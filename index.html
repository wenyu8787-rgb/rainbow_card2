<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸«æƒ…ç·’å½©è™¹å¡ - æ¯æ—¥æ¿€å‹µèˆ‡æ­·å²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Google å­—é«” Inter å’Œ Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- è¼‰å…¥ html2canvas å‡½å¼åº«ï¼Œç”¨æ–¼æˆªåœ–ä¸‹è¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* è¨­å®šå…¨åŸŸå­—é«”ï¼Œå„ªå…ˆä½¿ç”¨ Noto Sans TC æ”¯æ´ä¸­æ–‡ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f3f9; /* æŸ”å’Œæ·ºç´«è‰²èƒŒæ™¯ */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* å…§å®¹å€å¡Šçš„å…±åŒæœ€å¤§å¯¬åº¦ */
        .max-w-container {
            max-width: 42rem; /* ç´„ 672pxï¼Œç¢ºä¿çµæ§‹æ¸…æ™° */
            width: 100%;
        }

        /* å¡ç‰‡å°ˆå±¬æ¨£å¼ */
        .rainbow-card {
            min-height: 250px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            border: 4px solid #fff; /* ç™½è‰²é‚Šæ¡† */
            background-image: linear-gradient(135deg, #FFB6C1 0%, #FFDAB9 100%); /* é è¨­æ¼¸å±¤ (ç¬¬ä¸€å¼µå¡é¡è‰²) */
            background-size: 200% 200%;
            animation: gradient-shift 10s ease infinite;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* æŠ½å¡æŒ‰éˆ•æ¨£å¼ */
        .main-button {
            background-image: linear-gradient(45deg, #6B46C1, #9F7AEA); /* æŸ”å’Œç´«è‰²æ¼¸å±¤ */
            transition: all 0.3s ease;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 10px 20px rgba(159, 122, 234, 0.4);
            transform: translateY(-2px);
        }
        .main-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* åˆ—å°æŒ‰éˆ•æ¨£å¼ */
        .print-button {
            background-color: #4B5563; /* ç°è‰²èƒŒæ™¯ */
            transition: all 0.3s ease;
        }
        .print-button:hover {
            background-color: #374151; /* æ·±ç°è‰² */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        
        /* AI è§£è®€æŒ‰éˆ•æ¨£å¼ */
        .interpret-button {
            background-color: #FBBF24; /* ç¥ç€è‰² */
            color: #854D0E; /* æ·±æ£•è‰²æ–‡å­— */
            transition: all 0.3s ease;
        }
        .interpret-button:hover:not(:disabled) {
            background-color: #F59E0B;
            box-shadow: 0 5px 10px rgba(245, 158, 11, 0.4);
            transform: translateY(-1px);
        }
        .interpret-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* éš±è—å…§å®¹çš„å‹•ç•« */
        .hidden-content {
            opacity: 0;
            transform: translateY(10px);
        }
        .show-content {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        /* å¯å±•é–‹/æ”¶åˆå€å¡Šçš„æ¨£å¼ */
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible.active {
            max-height: 500px; /* è¨­ç½®ä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦ */
        }

        /* æ­·å²ç´€éŒ„å€å¡Šçš„å±•é–‹/æ”¶åˆæ¨£å¼ */
        .history-item-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .history-item-details.active {
            max-height: 200px; /* æ ¹æ“šå…§å®¹èª¿æ•´ */
            padding-top: 1rem;
        }
        
        /* é¡åƒå½©è™¹åœ–ç¤º */
        #mirroredRainbow {
            transform: scaleX(-1);
        }
        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .page-button {
            min-width: 40px;
        }
    </style>
</head>
<body>
    <div class="max-w-container">
        <!-- åˆ—å°/ä¸‹è¼‰çš„æ•æ‰å€åŸŸï¼ŒåŒ…å«ä¸ŠåŠéƒ¨å…§å®¹ -->
        <div id="printableArea" class="bg-white rounded-3xl p-6 md:p-10 shadow-2xl">
            <header class="text-center mb-8">
                <!-- æ¨™é¡Œï¼šå³å´å½©è™¹åœ–ç¤ºå·²æ·»åŠ é¡åƒ CSS -->
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒˆ æ•™å¸«æƒ…ç·’å½©è™¹å¡ <span id="mirroredRainbow" class="inline-block">ğŸŒˆ</span></h1>
                <p id="dateDisplay" class="text-lg text-purple-500 font-medium">ä»Šå¤©æ˜¯...</p>
                <p class="text-sm text-gray-500 mt-1">çµ¦è‡ªå·±ä¸€é»æº«æŸ”ï¼Œå¾å¡ç‰‡ä¸­æ±²å–åŠ›é‡ã€‚</p>
            </header>

            <!-- è¨Šæ¯/éŒ¯èª¤æç¤ºå€ -->
            <div id="messageBox" class="text-center p-3 mb-6 hidden rounded-xl" role="alert"></div>

            <!-- å½©è™¹å¡ç‰‡å€ -->
            <div id="cardContainer" class="rainbow-card flex flex-col justify-center items-center text-center p-8 rounded-2xl text-white">
                <p id="cardTitle" class="text-2xl font-bold mb-4">ç³»çµ±æº–å‚™ä¸­...</p>
                <p id="cardContent" class="text-lg hidden-content">å¡ç‰‡å…§å®¹</p>
                <p id="cardFooter" class="text-sm mt-4 hidden-content">ğŸŒŸ æ„Ÿè¬ä½ çš„ä»˜å‡º ğŸŒŸ</p>
            </div>
            
            <!-- Gemini API è§£è®€çµæœå€å¡Š (NEW) -->
            <div id="geminiInterpretationArea" class="mt-6 p-4 bg-purple-50 rounded-xl shadow-inner text-gray-700 hidden">
                <h3 class="text-lg font-semibold text-purple-700 mb-2">âœ¨ ä½ çš„ä»Šæ—¥æ‡‰ç”¨å»ºè­°ï¼š</h3>
                <p id="geminiInterpretationText"></p>
            </div>

        </div>
        <!-- çµæŸåˆ—å°æ•æ‰å€åŸŸ -->

        <!-- æŒ‰éˆ•å€å¡Š (ä½æ–¼æ•æ‰å€åŸŸä¸‹æ–¹) -->
        <div class="mt-8">
            <button id="drawButton" 
                    class="w-full py-3 px-6 rounded-xl text-white font-semibold text-lg shadow-lg main-button"
                    onclick="drawCard()" disabled>
                è¼‰å…¥ä¸­...
            </button>
            <div class="mt-4 flex flex-col md:flex-row justify-between gap-4">
                <button id="interpretButton" 
                        class="flex-1 py-3 px-6 rounded-xl font-semibold text-base shadow-lg interpret-button hidden"
                        onclick="getGeminiInterpretation()">
                    âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°
                </button>
                <button id="printButton" 
                        class="flex-1 py-3 px-6 rounded-xl text-white font-semibold text-base shadow-lg print-button hidden"
                        onclick="downloadCardImage()">
                    åˆ—å°/ä¸‹è¼‰å¡ç‰‡
                </button>
            </div>
        </div>
        <p id="statusText" class="text-sm mt-3 text-gray-500 text-center"></p>

        <!-- è‡ªè¨‚ä½³å¥ç®¡ç†å€å¡Š -->
        <div class="bg-white rounded-3xl p-6 md:p-10 shadow-2xl mt-6">
            <button onclick="toggleCustomCardsSection()"
                    class="w-full py-2 px-4 rounded-xl text-sm font-medium text-purple-600 bg-purple-50 hover:bg-purple-100 transition-colors flex justify-between items-center">
                <span>ç®¡ç†æˆ‘çš„ä½³å¥ (<span id="customCardCount">0</span> å¼µ)</span>
                <span id="toggleIcon">â–¼</span>
            </button>
            
            <div id="customCardsSection" class="collapsible">
                <div class="p-4 bg-gray-50 rounded-xl mt-3">
                    <h3 class="font-semibold text-gray-700 mb-2">æ–°å¢ä¸€å‰‡ä½³å¥ï¼š</h3>
                    <textarea id="newCustomQuote" class="w-full p-2 border rounded-lg focus:ring-purple-500 focus:border-purple-500 text-gray-800" rows="3" placeholder="è¼¸å…¥æ‚¨çš„æ¿€å‹µå¥å­ï¼ˆä¾‹å¦‚ï¼šæ•™è‚²æ˜¯ä¸€å ´é¦¬æ‹‰æ¾ï¼Œè€Œä¸æ˜¯çŸ­è·‘ã€‚ï¼‰"></textarea>
                    <button id="saveCustomCardButton"
                            onclick="handleSaveCustomCard()"
                            class="mt-2 w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors">
                        å„²å­˜ä½³å¥ä¸¦åŠ å…¥æŠ½å¡åº«
                    </button>
                    
                    <h3 class="font-semibold text-gray-700 mt-4 mb-2 border-t pt-3">æˆ‘çš„è‡ªè¨‚ä½³å¥åˆ—è¡¨ï¼š</h3>
                    <ul id="customCardsList" class="space-y-2 text-sm max-h-40 overflow-y-auto pr-2">
                        <!-- Custom cards will be listed here -->
                        <li class="text-gray-500 italic">æ­£åœ¨è¼‰å…¥æˆ–åˆå§‹åŒ–ä½³å¥...</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- æ­·å²ç´€éŒ„å€å¡Š (æ–°å¢) -->
        <div class="bg-white rounded-3xl p-6 md:p-10 shadow-2xl mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                æŠ½å–æ­·å²ç´€éŒ„
                <span id="historyCount" class="text-sm font-medium text-purple-500"></span>
            </h2>
            <div id="historyList" class="space-y-4">
                <p id="historyLoading" class="text-center text-gray-500">æ­£åœ¨è¼‰å…¥æ­·å²ç´€éŒ„...</p>
                <!-- æ­·å²ç´€éŒ„åˆ—è¡¨å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
            </div>
            <!-- åˆ†é æ§åˆ¶é … -->
            <nav id="paginationControls" class="mt-6 flex justify-center items-center space-x-2">
                <!-- åˆ†é æŒ‰éˆ•å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
            </nav>
        </div>
        <!-- æ­·å²ç´€éŒ„å€å¡Š (çµæŸ) -->

        <footer class="text-center mt-8 pt-4 border-t border-gray-100">
            <p class="text-xs text-gray-400">æ•¸æ“šå°‡å®‰å…¨å­˜å„²æ–¼æ‚¨çš„å°ˆå±¬ç©ºé–“ï¼Œç¢ºä¿æ¯æ—¥çš„æ¿€å‹µä¸é‡è¤‡ã€‚</p>
        </footer>
    </div>

    <!-- Firebase / Gemini è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, deleteDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firestore æ—¥èªŒç´šåˆ¥ç‚º Debug
        setLogLevel('Debug');

        // --- Global Variables and Environment Configuration ---
        // é€™äº›è®Šæ•¸æœƒåœ¨ initFirebase ä¹‹å¾Œè¢«è³¦å€¼
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        
        let customCards = []; 
        let allHistoryRecords = []; 
        let currentPage = 1; 
        const itemsPerPage = 10; 
        
        // ** M A N D A T O R Y ** Firebase Setup (Use environment variables)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Gemini API Configuration
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const systemPrompt = "ä½ æ˜¯ä¸€ä½å……æ»¿åŒç†å¿ƒä¸”ç¶“é©—è±å¯Œçš„è³‡æ·±æ•™å¸«é¡§å•ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„èªå¥ï¼Œç‚ºä½¿ç”¨è€…ï¼ˆä¸€ä½è€å¸«ï¼‰æä¾›ä¸€å€‹ç°¡æ½”ã€å¯¦ç”¨ä¸”æ­£å‘çš„æ‡‰ç”¨å»ºè­°ã€‚è«‹å°‡é€™å¥è©±èˆ‡æ—¥å¸¸æ•™å­¸å£“åŠ›ã€å­¸ç”ŸæŒ‘æˆ°æˆ–è‡ªæˆ‘ç…§é¡§è¯ç¹«èµ·ä¾†ï¼Œçµ¦äºˆæ”¯æŒå’Œå…·é«”è¡Œå‹•æ–¹å‘ã€‚å›æ‡‰å¿…é ˆé™åˆ¶åœ¨ä¸€å€‹æ®µè½å…§ï¼Œç´„ 80-100 å­—ã€‚";


        // åˆå§‹å…§å»ºå¡ç‰‡å…§å®¹ (å…± 64 å‰‡)
        const initialSeedCards = [
            "ä½ ä¸å­¤å–®ï¼Œä½ çš„åŠªåŠ›éƒ½æœ‰è¢«çœ‹åˆ°ã€‚",
            "ä½ çš„å°ˆæ¥­åƒ¹å€¼ç„¡å¯å–ä»£ï¼Œè«‹ç‚ºè‡ªå·±æ„Ÿåˆ°é©•å‚²ã€‚",
            "ä»Šå¤©ï¼Œä½ å·²ç¶“åšå¾—å¤ å¥½äº†ï¼Œçµ¦è‡ªå·±ä¸€å€‹å¾®ç¬‘ã€‚",
            "å…è¨±è‡ªå·±ä¼‘æ¯ï¼Œå……é›»å¾Œçš„ä½ æ›´æœ‰åŠ›é‡ã€‚",
            "ä½ çš„è©±èªï¼Œå¯èƒ½æ”¹è®Šäº†ä¸€å€‹å­©å­çš„ä¸€ç”Ÿï¼Œå½±éŸ¿åŠ›ç„¡é å¼—å±†ã€‚",
            "æ¯å€‹æŒ‘æˆ°ï¼Œéƒ½å°‡æˆç‚ºä½ æ•…äº‹è£¡æœ€ç²¾å½©çš„ä¸€é ã€‚",
            "å°‹æ±‚å”åŠ©æ˜¯åŠ›é‡çš„å±•ç¾ï¼Œä¸æ˜¯è»Ÿå¼±ã€‚",
            "æ”¾ä¸‹å°å°çš„æŒ«æŠ˜ï¼Œæ˜å¤©åˆæ˜¯å¶„æ–°çš„ä¸€å¤©ã€‚",
            "ä½ æ­£åœ¨å‰µé€ çš„æœªä¾†ï¼Œæ¯”ä½ æƒ³åƒçš„æ›´å®å¤§ã€‚",
            "ä¸€é¡†ç¨®å­çš„èŒèŠ½ï¼Œå¾€å¾€éœ€è¦å¾ˆä¹…çš„æ™‚å…‰ã€‚è€å¿ƒç­‰å¾…ã€‚",
            "ä½ çš„ç¬‘å®¹æ˜¯æœ€å¥½çš„æ•™æã€‚",
            "è€å¿ƒæ˜¯æ•™è‚²çš„é»ƒé‡‘æ³•å‰‡ã€‚",
            "ä»Šå¤©ï¼Œä½ å·²è¶…è¶Šæ˜¨å¤©çš„è‡ªå·±ã€‚",
            "çµ¦äºˆå­©å­ç©ºé–“ï¼Œå°±æ˜¯çµ¦äºˆä»–å€‘æˆé•·çš„åŠ›é‡ã€‚",
            "æ•™è‚²æ˜¯ä¸€å ´é¦¬æ‹‰æ¾ï¼Œè«‹è¨˜å¾—å‘¼å¸ã€‚",
            "ä½ çš„å°ˆæ¥­ï¼Œå€¼å¾—æ‰€æœ‰çš„å°Šé‡ã€‚",
            "ä¿æŒå¥½å¥‡å¿ƒï¼Œä½ å°±æ˜¯æœ€å¥½çš„å­¸ç¿’è€…ã€‚",
            "åˆ¥å¿˜äº†ï¼Œä½ ä¹Ÿæ˜¯éœ€è¦è¢«ç…§é¡§çš„å­©å­ã€‚",
            "çœŸæ­£çš„å½±éŸ¿ï¼Œå¾€å¾€ç™¼ç”Ÿåœ¨ç„¡è²è™•ã€‚",
            "å°å°çš„é€²æ­¥ï¼Œç´¯ç©æˆå·¨å¤§çš„æˆåŠŸã€‚",
            "ç›¸ä¿¡ä½ çš„ç›´è¦ºï¼Œé‚£æ˜¯ç¶“é©—çš„ç´¯ç©ã€‚",
            "ç”¨æ„›å¿ƒçŒæº‰ï¼Œç”¨ç†æ€§ä¿®å‰ªã€‚",
            "å¶çˆ¾æ”¾æ…¢è…³æ­¥ï¼Œæ‰èƒ½çœ‹æ¸…æ–¹å‘ã€‚",
            "æ¯å¤©éƒ½æ˜¯æ–°çš„é–‹å§‹ï¼Œæ–°çš„æ©Ÿæœƒã€‚",
            "ä½ çš„ç†±æƒ…æ˜¯èª²å ‚ä¸Šæœ€äº®çš„ç‡ˆå…‰ã€‚",
            "æ“æŠ±ä¸å®Œç¾ï¼Œå› ç‚ºé‚£æ‰æ˜¯çœŸå¯¦çš„äººç”Ÿã€‚",
            "æ•™å¸«çš„åŠ›é‡ï¼Œåœ¨æ–¼é»ç‡ƒè€Œéæ³¨æ»¿ã€‚",
            "è«‹è¨˜ä½ä½ æœ€åˆçš„å¤¢æƒ³èˆ‡ä½¿å‘½ã€‚",
            "å…è¨±è‡ªå·±æœ‰æƒ…ç·’ï¼Œé€™æ˜¯å¥åº·çš„è¡¨ç¾ã€‚",
            "åœ˜éšŠåˆä½œï¼Œè®“æŒ‘æˆ°è®Šå¾—è¼•è€Œæ˜“èˆ‰ã€‚",
            "ä½ çš„è©±èªï¼Œæ“æœ‰æ”¹è®Šä¸–ç•Œçš„åŠ›é‡ã€‚",
            "æ‰¾åˆ°å…§å¿ƒçš„å¹³éœï¼Œæ··äº‚è‡ªç„¶é€€å»ã€‚",
            "å°ˆæ³¨æ–¼ä½ èƒ½æ§åˆ¶çš„äº‹æƒ…ã€‚",
            "æ„Ÿè¬ä»Šå¤©é‡åˆ°çš„æ¯ä¸€å€‹ç¾å¥½ç¬é–“ã€‚",
            "æˆé•·ä¸æ˜¯ç·šæ€§çš„ï¼Œå…è¨±æ›²ç·šç™¼ç”Ÿã€‚",
            "ä¼‘æ¯ä¸æ˜¯æ”¾æ£„ï¼Œè€Œæ˜¯ç‚ºäº†æ›´é•·é çš„è·¯ã€‚",
            "ä½ æ‰€åšçš„ä¸€åˆ‡ï¼Œéƒ½åœ¨é»˜é»˜å½±éŸ¿è‘—æœªä¾†ã€‚",
            "ä»Šå¤©ï¼Œè«‹å°è‡ªå·±æº«æŸ”ä¸€é»ã€‚",
            "ä½ çš„åƒ¹å€¼ï¼Œä¸å–æ±ºæ–¼å­¸ç”Ÿçš„æˆç¸¾ã€‚",
            "å‰µæ„æ˜¯è§£æ±ºå•é¡Œçš„æœ€å¥½å·¥å…·ã€‚",
            "æ¯å€‹å­©å­éƒ½å€¼å¾—ä½ çš„æ™‚é–“å’Œé—œæ³¨ã€‚",
            "ä¿æŒå½ˆæ€§ï¼Œåƒæ°´ä¸€æ¨£é©æ‡‰ç’°å¢ƒã€‚",
            "ä»Šå¤©çš„æŒ«æŠ˜ï¼Œå°‡æ˜¯ä½ æ˜å¤©çš„ç¶“é©—ã€‚",
            "ä½ æ˜¯å¼•å°è€…ï¼Œè€Œä¸æ˜¯æŒ‡æ®å®˜ã€‚",
            "ä½ çš„å­˜åœ¨ï¼Œè®“é€™ä¸–ç•Œæ›´ç¾å¥½ã€‚",
            "å­¸ç¿’æ”¾æ‰‹ï¼Œçµ¦äºˆä¿¡ä»»ã€‚",
            "å°ˆæ³¨æ–¼éç¨‹ï¼Œæˆæœè‡ªç„¶æ°´åˆ°æ¸ æˆã€‚",
            "æ„Ÿè¬é‚£äº›è®“ä½ æˆé•·çš„å›°é›£ã€‚",
            "ä½ çš„è€å¿ƒï¼Œæ˜¯æœ€å¥½çš„ç¦®ç‰©ã€‚",
            "ç”¨ä½ çš„ç†±æƒ…ï¼Œå‚³æŸ“çµ¦å‘¨åœçš„äººã€‚",
            "çµ¦è‡ªå·±ä¸€å€‹æš«åœéµï¼Œé‡æ–°æ ¡æº–ã€‚",
            "ä½ å€¼å¾—æ“æœ‰ä¸€å€‹å……æ»¿é™½å…‰çš„ä¸€å¤©ã€‚",
            "ä½ çš„ç•Œç·šï¼Œæ˜¯ä¿è­·è‡ªå·±çš„åœç‰†ã€‚",
            "ä»Šå¤©ï¼Œæ±ºå®šä½ æƒ³è¦æˆç‚ºä»€éº¼æ¨£çš„äººã€‚",
            "äº«å—ç•¶ä¸‹ï¼Œæ•™å­¸ä¸­çš„å°ç¢ºå¹¸ã€‚",
            "ç›¸ä¿¡è‡ªå·±ï¼Œä½ æ“æœ‰æ‰€æœ‰çš„è³‡æºã€‚",
            "å¾éŒ¯èª¤ä¸­å­¸ç¿’ï¼Œæ°¸ä¸åœæ­¢æ¢ç´¢ã€‚",
            "æ¯å€‹å­©å­éƒ½æœ‰ç¨ç‰¹çš„å¤©è³¦ã€‚",
            "ä»Šå¤©å°±åšï¼Œä¸è¦æ‹–å»¶ä½ çš„å¹¸ç¦ã€‚",
            "ä½ çš„æŠ•å…¥ï¼Œæ˜¯ç„¡åƒ¹çš„è³‡ç”¢ã€‚",
            "å°ˆæ³¨æ–¼ä¸€æ¬¡åªåšä¸€ä»¶äº‹ã€‚",
            "æŒ‘æˆ°æ˜¯å½è£çš„æ©Ÿæœƒã€‚",
            "ä¿æŒæ¨‚è§€ï¼Œå®ƒæ˜¯æœ€å¥½çš„å…ç–«åŠ›ã€‚",
            "ä½ æ˜¯å…‰ï¼Œç…§äº®äº†è¨±å¤šäººçš„è·¯ã€‚",
            "å‚¾è½å…§å¿ƒçš„è²éŸ³ï¼Œå®ƒçŸ¥é“ç­”æ¡ˆã€‚",
            "å…è¨±æ”¹è®Šï¼Œæ“æŠ±ä¸ç¢ºå®šæ€§ã€‚",
            "ä½ çš„ä»˜å‡ºï¼Œæ˜¯æ„›çš„å»¶çºŒã€‚",
            "è¨˜å¾—å°è‡ªå·±èªªè²ã€Œè¬è¬ã€ã€‚",
            "è®“ç°¡å–®çš„äº‹æƒ…ä¿æŒç°¡å–®ã€‚",
            "ä½ å·²ç¶“æˆåŠŸåº¦éäº†è¨±å¤šé›£é—œã€‚",
        ];

        // å½©è™¹å¡ç‰‡é¡è‰² (æŸ”å’Œæ¼¸è®Š)
        const rainbowColors = [
            ['#FFB6C1', '#FFDAB9'], // è¼•ç²‰/èœœæ¡ƒ
            ['#FFA07A', '#FFDEAD'], // æ·ºæ©™/å¥¶æ²¹
            ['#ADD8E6', '#87CEFA'], // æ·ºè—/å¤©ç©º
            ['#98FB98', '#ADFF2F'], // æ·ºç¶ /é»ƒç¶ 
            ['#BA55D3', '#DA70D6'], // ä¸­ç´«/è˜­ç´«
            ['#F08080', '#FA8072'], // çŠç‘š/é®­é­š
            ['#DAA520', '#BDB76B'], // é‡‘é»ƒ/æ©„æ¬–
        ];

        // å–å¾—ä»Šå¤©çš„æ—¥æœŸ (YYYY-MM-DD)
        const getTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // æ ¼å¼åŒ–æ™‚é–“æˆ³ç‚º YYYY-MM-DD HH:MM
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'æœªçŸ¥æ—¥æœŸ';
            const date = new Date(timestamp);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${h}:${min}`;
        };

        document.getElementById('dateDisplay').textContent = `ä»Šå¤©æ˜¯ ${getTodayDate()}`;
        document.getElementById('cardTitle').textContent = "ç³»çµ±æº–å‚™ä¸­...";

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡åˆå§‹ä½³å¥å¯«å…¥ Firestore (åƒ…åœ¨ç¬¬ä¸€æ¬¡é‹è¡Œæ™‚åŸ·è¡Œ)
        const seedInitialCards = async () => {
            if (!db || !userId) return;
            
            const customCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_cards`);
            try {
                // æª¢æŸ¥é›†åˆæ˜¯å¦ç‚ºç©º
                const snapshot = await getDocs(customCollectionRef);
                
                if (snapshot.empty) {
                    console.log("Custom cards collection is empty, seeding initial quotes...");
                    for (const quote of initialSeedCards) {
                        await addDoc(customCollectionRef, {
                            quote: quote,
                            createdAt: new Date().getTime(),
                            isInitialSeed: true 
                        });
                    }
                    console.log(`Initial ${initialSeedCards.length} quotes successfully seeded.`);
                } else {
                    console.log("Custom cards already exist. Skipping seeding.");
                }
            } catch (error) {
                console.error("Seeding initial quotes failed:", error);
            }
        };


        // åˆå§‹åŒ– Firebase
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase é…ç½®ç¼ºå¤±ã€‚");
                 showMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼šFirebase é…ç½®ç¼ºå¤±ã€‚", 'error');
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); // è³¦å€¼çµ¦å…¨åŸŸ db
                auth = getAuth(app); // è³¦å€¼çµ¦å…¨åŸŸ auth

                // ç¢ºä¿ç™»å…¥ä¸¦ç­‰å¾…èªè­‰ç‹€æ…‹ç©©å®š
                await new Promise(async (resolve) => {
                    try {
                         // ä½¿ç”¨ Custom Token æˆ–åŒ¿åç™»å…¥
                         if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                         } else {
                             await signInAnonymously(auth);
                         }
                    } catch (e) {
                        console.error("èªè­‰å¤±æ•—:", e);
                    }
                    
                    // è¨»å†Šèªè­‰ç‹€æ…‹è®Šæ›´ç›£è½å™¨ï¼ŒåªåŸ·è¡Œä¸€æ¬¡
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase èªè­‰å®Œæˆï¼ŒUserID:", userId);
                        } else {
                            // è¬ä¸€èªè­‰å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ IDï¼Œä½† Firestore å¯«å…¥æœƒå› å®‰å…¨è¦å‰‡å¤±æ•—
                            userId = crypto.randomUUID(); 
                            console.warn("æœªåµæ¸¬åˆ°æœ‰æ•ˆ Auth Tokenï¼Œä½¿ç”¨éš¨æ©Ÿ IDï¼Œå¯«å…¥æ“ä½œå¯èƒ½å—é˜»ã€‚");
                        }
                        isAuthReady = true;
                        unsubscribe(); 
                        resolve();
                    });
                });
                
                // åªæœ‰åœ¨ isAuthReady ä¸” userId ç¢ºå®šå¾Œæ‰åŸ·è¡Œ Firestore æ“ä½œ
                if (isAuthReady) {
                    // 1. åŸ·è¡Œåˆå§‹å¡ç‰‡å¯«å…¥ (å¦‚æœé›†åˆæ˜¯ç©ºçš„)
                    await seedInitialCards(); 
                    
                    // 2. è¨­å®šæ‰€æœ‰ç›£è½å™¨ (å¿…é ˆåœ¨ seedInitialCards ä¹‹å¾Œ)
                    setupCustomCardsListener(); // è¨­å®šè‡ªè¨‚å¡ç‰‡å³æ™‚ç›£è½ (åŒ…å«åˆå§‹å¡ç‰‡)
                    setupDrawHistoryListener(); // è¨­å®šæ­·å²ç´€éŒ„å³æ™‚ç›£è½
                    checkTodayCard(); // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½å¡
                }

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showMessage("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä¿å­˜å¡ç‰‡ç´€éŒ„ã€‚", 'error');
                isAuthReady = true; 
            }
        };

        // é¡¯ç¤ºè¨Šæ¯æ¡†
        const showMessage = (text, type = 'info') => {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700', 'bg-red-500', 'text-white');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                box.classList.add('bg-red-500', 'text-white'); // å¸å¼•æ³¨æ„çš„è­¦å‘Š
            } else {
                box.classList.add('bg-blue-100', 'text-blue-700');
            }
            // è¨Šæ¯é¡¯ç¤ºå¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
            box.classList.remove('hidden');
        };

        // æ›´æ–°å¡ç‰‡è¦–è¦ºæ•ˆæœ
        const updateCardVisuals = (colorIndex) => {
            const cardElement = document.getElementById('cardContainer');
            // ç¢ºä¿é¡è‰²ç´¢å¼•åœ¨ç¯„åœå…§
            const randomColorIndex = colorIndex % rainbowColors.length; 
            const [color1, color2] = rainbowColors[randomColorIndex];
            
            cardElement.style.backgroundImage = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
            cardElement.classList.add('scale-105');
            setTimeout(() => cardElement.classList.remove('scale-105'), 300);
        };

        // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æŠ½å¡ (ç¾åœ¨åƒ…ç”¨æ–¼åˆå§‹åŒ–é¡¯ç¤º)
        const checkTodayCard = async () => {
            if (!isAuthReady || !userId || !db) return;

            // æª¢æŸ¥ history é›†åˆä¸­æœ€è¿‘çš„ä¸€ç­†
            const historyRef = collection(db, `artifacts/${appId}/users/${userId}/draw_history`);
            const q = query(historyRef); 

            try {
                const querySnapshot = await getDocs(q);
                let history = [];
                querySnapshot.forEach(doc => history.push({ id: doc.id, ...doc.data() }));

                // æ ¹æ“šæ™‚é–“æˆ³æ’åºï¼Œæ‰¾åˆ°æœ€æ–°çš„ä¸€ç­†
                history.sort((a, b) => b.timestamp - a.timestamp);
                const latestCard = history[0];
                
                const today = getTodayDate();
                const drawButton = document.getElementById('drawButton');
                const printButton = document.getElementById('printButton');
                const interpretButton = document.getElementById('interpretButton');
                
                // åˆ¤æ–·æœ€æ–°ä¸€ç­†æ˜¯å¦æ˜¯ä»Šå¤©æŠ½å–çš„
                const isFirstDraw = !latestCard || formatTimestamp(latestCard.timestamp).startsWith(today) === false;
                
                if (!isFirstDraw) {
                    // ä»Šå¤©å·²æŠ½å¡
                    displayDrawnCard(latestCard.cardMessage, latestCard.cardIndex, latestCard.geminiInterpretation);
                    
                    drawButton.disabled = false;
                    drawButton.textContent = "é‡æ–°æŠ½å–";
                    printButton.classList.remove('hidden'); 
                    interpretButton.classList.remove('hidden'); 
                    document.getElementById('statusText').textContent = "ä»Šå¤©å·²æŠ½éå¡ï¼Œä½†æ‚¨ä»å¯å†æ¬¡æŠ½å–ä¸¦è¦†è“‹æ­·å²ç´€éŒ„ã€‚";
                    showMessage("æ­¡è¿å›ä¾†ï¼é€™æ˜¯æ‚¨æœ€è¿‘æŠ½å–çš„å¡ç‰‡ã€‚", 'info');
                    return;
                }
                
                // ä»Šå¤©å°šæœªæŠ½å¡
                drawButton.disabled = false;
                drawButton.textContent = "æŠ½å–ä»Šæ—¥å½©è™¹å¡";
                printButton.classList.add('hidden'); 
                interpretButton.classList.add('hidden'); 
                document.getElementById('cardTitle').textContent = "é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒæŠ½å–ä½ çš„æ¯æ—¥æ¿€å‹µ";
                document.getElementById('cardContent').classList.remove('show-content');
                document.getElementById('cardFooter').classList.remove('show-content');

                showMessage("æº–å‚™å¥½äº†å—ï¼Ÿé»æ“ŠæŒ‰éˆ•æŠ½å–ä»Šæ—¥æ¿€å‹µã€‚", 'info');

            } catch (error) {
                console.error("æª¢æŸ¥ä»Šæ—¥å¡ç‰‡ç´€éŒ„å¤±æ•—:", error);
                showMessage("æª¢æŸ¥ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ‚¨ Firestore çš„å®‰å…¨è¦å‰‡ã€‚", 'error');
                drawButton.disabled = false;
                drawButton.textContent = "æŠ½å–ä»Šæ—¥å½©è™¹å¡";
                printButton.classList.add('hidden');
                interpretButton.classList.add('hidden');
            }
        };

        // é¡¯ç¤ºå·²æŠ½å–å¡ç‰‡ (æˆ–æ­·å²ç´€éŒ„å¡ç‰‡)
        const displayDrawnCard = (message, colorIndex, interpretation = null) => {
            const titleElement = document.getElementById('cardTitle');
            const contentElement = document.getElementById('cardContent');
            const footerElement = document.getElementById('cardFooter');
            const printButton = document.getElementById('printButton');
            const interpretButton = document.getElementById('interpretButton');
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText');

            // é‡ç½®å‹•ç•«
            contentElement.classList.remove('show-content');
            footerElement.classList.remove('show-content');
            void contentElement.offsetWidth; 
            void footerElement.offsetWidth; 

            titleElement.textContent = "æœ€æ–°æ¿€å‹µå¡ç‰‡ï¼š"; 
            contentElement.textContent = message;
            
            contentElement.classList.add('show-content');
            footerElement.classList.add('show-content');
            
            updateCardVisuals(colorIndex); // ä½¿ç”¨ colorIndex æ›´æ–°é¡è‰²
            printButton.classList.remove('hidden'); 
            interpretButton.classList.remove('hidden'); 
            interpretButton.disabled = false; // æ¢å¾© AI æŒ‰éˆ•ç‹€æ…‹

            // è™•ç†æ­·å²è¨˜éŒ„ä¸­çš„ AI è§£è®€çµæœ
            if (interpretation) {
                interpretationArea.classList.remove('hidden');
                interpretationText.innerHTML = interpretation.replace(/\n/g, '<br>');
                interpretButton.disabled = true; // å¦‚æœå·²ç¶“æœ‰è§£è®€ï¼Œå°±ç¦ç”¨æŒ‰éˆ•
                interpretButton.textContent = "âœ¨ å·²ç²å¾—æ‡‰ç”¨å»ºè­°";
            } else {
                interpretationArea.classList.add('hidden');
                interpretationText.textContent = '';
                interpretButton.textContent = "âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°";
            }
        };
        
        // é‡æ–°é¡¯ç¤ºæ­·å²ç´€éŒ„å¡ç‰‡åˆ°ä¸»ç•«é¢ä¸Š
        window.displayHistoryCard = (message, colorIndex, interpretation) => {
            // ç¢ºä¿å°‡ç©ºå­—ä¸²è½‰æ›å› nullï¼Œä»¥ä¾¿ displayDrawnCard æ­£ç¢ºè™•ç†
            const decodedInterpretation = interpretation === '' ? null : interpretation.replace(/\\'/g, "'").replace(/\\"/g, '"');
            const decodedMessage = message.replace(/\\'/g, "'").replace(/\\"/g, '"');
            
            // å‘¼å«ç¾æœ‰çš„é¡¯ç¤ºå‡½æ•¸ä¾†æ›´æ–°ä¸»å¡ç‰‡ UI
            displayDrawnCard(decodedMessage, colorIndex, decodedInterpretation);

            // æ›´æ–°ç‹€æ…‹è¨Šæ¯
            document.getElementById('statusText').textContent = "é€™æ˜¯å¾æ­·å²ç´€éŒ„ä¸­é‡æ–°é¡¯ç¤ºçš„å¡ç‰‡å…§å®¹ã€‚æ‚¨å¯ä»¥é»æ“Š AI æŒ‰éˆ•ç”Ÿæˆæ‡‰ç”¨å»ºè­°æˆ–é‡æ–°æŠ½å–ã€‚";
            
            // ç¢ºä¿æŠ½å¡æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
            const drawButton = document.getElementById('drawButton');
            drawButton.disabled = false;
            drawButton.textContent = "é‡æ–°æŠ½å–";
            showMessage("æ­·å²å¡ç‰‡å·²é¡¯ç¤ºæ–¼ä¸»ç•«é¢ã€‚", 'info');
        };


        // æŠ½å¡ä¸»é‚è¼¯
        window.drawCard = async () => {
            if (!isAuthReady || !db || !userId) {
                showMessage("ç³»çµ±æº–å‚™ä¸­æˆ–èªè­‰å¤±æ•—ï¼Œè«‹ç¨å€™...", 'info');
                return;
            }

            const today = getTodayDate();
            const drawButton = document.getElementById('drawButton');

            // ç¢ºä¿æŒ‰éˆ•è¢«ç¦ç”¨ï¼Œé¿å…é‡è¤‡é»æ“Š
            drawButton.disabled = true;
            drawButton.textContent = "æŠ½å–ä¸­...";

            try {
                // 1. å¡ç‰‡åº«ç¾åœ¨åªä½¿ç”¨ customCards (å·²åŒ…å«åˆå§‹åŒ–çš„å…§å»ºå¡ç‰‡)
                const combinedCardPool = customCards.map(c => c.quote);
                
                if (combinedCardPool.length === 0) {
                    showMessage("å¡ç‰‡åº«ç‚ºç©ºï¼è«‹å…ˆæ–°å¢ä½³å¥ã€‚", 'warning');
                    drawButton.disabled = false;
                    drawButton.textContent = "é‡æ–°æŠ½å–";
                    return;
                }

                // 2. éš¨æ©Ÿé¸å–ä¸€å¼µå¡ç‰‡
                const randomIndex = Math.floor(Math.random() * combinedCardPool.length);
                const drawnCardMessage = combinedCardPool[randomIndex];
                
                // 3. éš¨æ©Ÿé¸å–ä¸€å€‹é¡è‰²ç´¢å¼•
                const colorIndex = Math.floor(Math.random() * rainbowColors.length);

                // 4. æ›´æ–°å¡ç‰‡è¦–è¦ºèˆ‡å…§å®¹
                displayDrawnCard(drawnCardMessage, colorIndex);

                // 5. å°‡æŠ½å–çµæœå­˜å…¥ Firestore çš„ history é›†åˆ
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/draw_history`);
                await addDoc(historyCollectionRef, {
                    cardMessage: drawnCardMessage,
                    cardIndex: colorIndex, 
                    drawnDate: today,
                    timestamp: new Date().getTime(),
                    geminiInterpretation: null 
                });
                
                drawButton.disabled = false;
                drawButton.textContent = "é‡æ–°æŠ½å–";
                document.getElementById('statusText').textContent = "åŠ›é‡å·²æ³¨å…¥ï¼é€™ä»½è¨˜éŒ„å·²å„²å­˜æ–¼æ‚¨çš„æ­·å²ç´€éŒ„ä¸­ã€‚";
                showMessage("æŠ½å–æˆåŠŸï¼é€™ä»½æ¿€å‹µå°‡ä¼´éš¨ä½ ä¸€æ•´å¤©ã€‚", 'success');

            } catch (error) {
                console.error("æŠ½å–å¡ç‰‡ä¸¦å„²å­˜ç´€éŒ„å¤±æ•—:", error);
                showMessage("æŠ½å–ç´€éŒ„å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firestore å®‰å…¨è¦å‰‡ã€‚", 'error');
                drawButton.disabled = false; 
                drawButton.textContent = "é‡æ–°æŠ½å–"; 
            }
        };

        // --- Gemini API æ¿€å‹µèªå¥è§£è®€åŠŸèƒ½ ---
        window.getGeminiInterpretation = async () => {
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText');
            const interpretButton = document.getElementById('interpretButton');
            const drawnCardContent = document.getElementById('cardContent').textContent;
            
            if (!drawnCardContent || drawnCardContent === 'å¡ç‰‡å…§å®¹' || drawnCardContent === 'ç³»çµ±æº–å‚™ä¸­...') {
                showMessage('è«‹å…ˆæŠ½å–ä»Šæ—¥å¡ç‰‡ï¼', 'warning');
                return;
            }

            interpretationArea.classList.remove('hidden');
            interpretationText.innerHTML = '<div class="text-center animate-pulse">æ­£åœ¨å‘¼å« Gemini AI æ™ºæ…§è§£è®€ä¸­... è«‹ç¨å€™ âœ¨</div>';
            interpretButton.disabled = true;
            interpretButton.textContent = "AI è§£è®€ä¸­...";


            const userQuery = `è«‹æ ¹æ“šé€™å¥æ•™å¸«æ¿€å‹µèªå¥ï¼šã€Œ${drawnCardContent}ã€ï¼Œæä¾›æ‡‰ç”¨å»ºè­°ã€‚`;
            
            // API Call Setup (using exponential backoff)
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            let success = false;
            let retries = 0;
            const maxRetries = 5;

            while (retries < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        success = true;
                        break;
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retries++;
                    } else {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Fetch error during retry:', error);
                    retries++;
                    if (retries >= maxRetries) throw error; 
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            if (success) {
                try {
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        interpretationText.innerHTML = text.replace(/\n/g, '<br>');
                        showMessage('AI è§£è®€å·²å®Œæˆï¼', 'success');
                        
                        await updateLatestCardInterpretation(drawnCardContent, text);
                        interpretButton.textContent = "âœ¨ å·²ç²å¾—æ‡‰ç”¨å»ºè­°";
                        interpretButton.disabled = true; 
                    } else {
                        interpretationText.textContent = 'AI è§£è®€å¤±æ•—ï¼šç„¡æ³•å–å¾—æœ‰æ•ˆçš„æ–‡å­—å›æ‡‰ã€‚';
                        interpretButton.textContent = "âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°";
                        interpretButton.disabled = false;
                    }
                } catch (e) {
                    console.error('Parsing or processing error:', e);
                    interpretationText.textContent = 'AI è§£è®€å¤±æ•—ï¼šè§£æå›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
                    interpretButton.textContent = "âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°";
                    interpretButton.disabled = false;
                }
            } else {
                interpretationText.textContent = 'AI è§£è®€è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚';
                interpretButton.textContent = "âœ¨ ç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°";
                interpretButton.disabled = false;
            }
        };

        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°æ­·å²ç´€éŒ„ä¸­æœ€æ–°æŠ½å¡çš„ AI è§£è®€çµæœ
        const updateLatestCardInterpretation = async (cardMessage, interpretationText) => {
            if (!isAuthReady || !userId || !db) return;

            const historyRef = collection(db, `artifacts/${appId}/users/${userId}/draw_history`);
            const q = query(historyRef); 

            try {
                const querySnapshot = await getDocs(q);
                let latestDoc = null;
                let latestTimestamp = 0;

                // æ‰¾åˆ°èˆ‡ç›®å‰å¡ç‰‡å…§å®¹å’Œæ™‚é–“æˆ³æœ€åŒ¹é…çš„æœ€æ–°ä¸€ç­†ç´€éŒ„
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.cardMessage === cardMessage && data.timestamp > latestTimestamp) {
                        latestTimestamp = data.timestamp;
                        latestDoc = doc;
                    }
                });

                if (latestDoc) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/draw_history`, latestDoc.id);
                    await setDoc(docRef, { geminiInterpretation: interpretationText }, { merge: true });
                    console.log(`æˆåŠŸæ›´æ–°æ­·å²ç´€éŒ„ ${latestDoc.id} çš„ AI è§£è®€ã€‚`);
                } else {
                    console.warn("æœªæ‰¾åˆ°æœ€æ–°æŠ½å¡ç´€éŒ„é€²è¡Œæ›´æ–°ã€‚");
                }
            } catch (error) {
                console.error("æ›´æ–° AI è§£è®€åˆ°æ­·å²ç´€éŒ„å¤±æ•—:", error);
            }
        };


        // --- åˆ—å°/ä¸‹è¼‰åŠŸèƒ½ ---
        window.downloadCardImage = async () => {
            const printArea = document.getElementById('printableArea');
            const drawButton = document.getElementById('drawButton');
            const printButton = document.getElementById('printButton');
            const interpretButton = document.getElementById('interpretButton');
            const interpretationArea = document.getElementById('geminiInterpretationArea');
            const interpretationText = document.getElementById('geminiInterpretationText');

            // æš«æ™‚éš±è—æŒ‰éˆ•ï¼Œç¢ºä¿æˆªåœ–ä¹¾æ·¨
            drawButton.classList.add('hidden');
            printButton.classList.add('hidden');
            interpretButton.classList.add('hidden'); 

            // æª¢æŸ¥ AI è§£è®€å€æ˜¯å¦å·²å±•é–‹ï¼Œè‹¥æœªå±•é–‹å‰‡æš«æ™‚æ”¶åˆ
            const wasInterpretationAreaHidden = interpretationArea.classList.contains('hidden');
            if (wasInterpretationAreaHidden) {
                // å¦‚æœ AI è§£è®€å…§å®¹æ˜¯ç©ºçš„ï¼Œå‰‡ä¿æŒéš±è—ï¼Œé¿å…æˆªåœ–å‡ºç¾ç©ºå€åŸŸ
                if (interpretationText.textContent !== '') {
                    interpretationArea.classList.remove('hidden');
                }
            }
            
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿ DOM ç‹€æ…‹æ›´æ–°å®Œæˆ
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(printArea, {
                        backgroundColor: '#f7f3f9', // æ•æ‰å€åŸŸçš„èƒŒæ™¯è‰²
                        scale: 2, // ä½¿ç”¨è¼ƒé«˜è§£æåº¦æˆªåœ–
                    });

                    const today = getTodayDate();
                    const fileName = `æƒ…ç·’å½©è™¹å¡_${today}.png`;
                    
                    // å‰µå»ºè‡¨æ™‚ä¸‹è¼‰é€£çµ
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = fileName;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showMessage("å¡ç‰‡åœ–ç‰‡å·²æˆåŠŸä¸‹è¼‰ï¼", 'success');
                } catch (error) {
                    console.error("ä¸‹è¼‰å¡ç‰‡åœ–ç‰‡å¤±æ•—:", error);
                    showMessage("ä¸‹è¼‰å¡ç‰‡åœ–ç‰‡å¤±æ•—ã€‚", 'error');
                } finally {
                    // æ¢å¾©æŒ‰éˆ•å¯è¦‹æ€§
                    drawButton.classList.remove('hidden');
                    printButton.classList.remove('hidden');
                    // åªæœ‰åœ¨ AI è§£è®€æŒ‰éˆ•æœªè¢«é»æ“Šæ™‚ï¼Œæ‰æ¢å¾©å®ƒçš„å¯è¦‹æ€§
                    if (document.getElementById('cardContent').textContent !== 'å¡ç‰‡å…§å®¹' && document.getElementById('cardContent').textContent !== 'ç³»çµ±æº–å‚™ä¸­...') {
                        interpretButton.classList.remove('hidden');
                    }
                    
                    // æ¢å¾© AI è§£è®€å€å¡Šçš„éš±è—ç‹€æ…‹ (å¦‚æœåŸæœ¬æ˜¯éš±è—çš„)
                    if (wasInterpretationAreaHidden) {
                        interpretationArea.classList.add('hidden');
                    }
                }
            }, 100); 
        };
        // --- è‡ªè¨‚ä½³å¥åŠŸèƒ½ (CRUD) ---

        // è¨­å®šè‡ªè¨‚å¡ç‰‡çš„å³æ™‚ç›£è½ 
        const setupCustomCardsListener = () => {
            if (!isAuthReady || !userId || !db) return;

            const customCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_cards`);
            
            onSnapshot(query(customCollectionRef), (snapshot) => {
                const fetchedCards = [];
                snapshot.forEach(doc => {
                    fetchedCards.push({ id: doc.id, ...doc.data() });
                });
                customCards = fetchedCards;
                renderCustomCardsList();
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œä¸”æœ‰å¡ç‰‡ï¼Œæ‰å•Ÿç”¨æŠ½å¡æŒ‰éˆ•
                const drawButton = document.getElementById('drawButton');
                if (customCards.length > 0 && drawButton.textContent === 'è¼‰å…¥ä¸­...') {
                     checkTodayCard();
                }

            }, (error) => {
                console.error("ç›£è½è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                showMessage("è¼‰å…¥æ¿€å‹µä½³å¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡ã€‚", 'error');
            });
        };

        // æ¸²æŸ“è‡ªè¨‚ä½³å¥åˆ—è¡¨
        const renderCustomCardsList = () => {
            const listElement = document.getElementById('customCardsList');
            const countElement = document.getElementById('customCardCount');
            listElement.innerHTML = ''; 
            
            countElement.textContent = customCards.length;

            if (customCards.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500 italic">ç›®å‰æ²’æœ‰ä»»ä½•ä½³å¥ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</li>';
                return;
            }

            customCards.forEach(card => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-white rounded-lg border';
                li.innerHTML = `
                    <span class="flex-1 mr-4 text-gray-700">${card.quote}</span>
                    <button data-id="${card.id}" 
                            onclick="handleDeleteCustomCard(this.dataset.id)"
                            class="p-1 text-red-500 hover:text-red-700 rounded-full transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                listElement.appendChild(li);
            });
        };

        // å„²å­˜æ–°çš„è‡ªè¨‚ä½³å¥ (ä¿®æ­£å¯«å…¥æ™‚æ©Ÿå’ŒéŒ¯èª¤å›é¥‹)
        window.handleSaveCustomCard = async () => {
            const input = document.getElementById('newCustomQuote');
            const quote = input.value.trim();
            const saveButton = document.getElementById('saveCustomCardButton');
            
            saveButton.disabled = true; // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡æäº¤

            if (!isAuthReady || !db || !userId) {
                console.error("Firebase State Error: isAuthReady:", isAuthReady, "DB:", db, "UserID:", userId);
                showMessage("ç³»çµ±å°šæœªæº–å‚™å¥½ï¼ˆèªè­‰ä¸­ï¼‰ï¼Œè«‹ç¨å€™å†è©¦ã€‚æˆ–æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚", 'error');
                saveButton.disabled = false;
                return;
            }

            if (quote.length < 5) {
                showMessage("ä½³å¥å…§å®¹å¤ªçŸ­äº†ï¼Œè«‹è‡³å°‘è¼¸å…¥ 5 å€‹å­—ã€‚", 'warning');
                saveButton.disabled = false;
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ä½³å¥ (ç°¡å–®å»é‡)
            if (customCards.some(card => card.quote === quote)) {
                showMessage("æ­¤ä½³å¥å·²ç¶“åœ¨å¡åº«ä¸­ã€‚", 'warning');
                saveButton.disabled = false;
                return;
            }

            try {
                // ç¢ºå®šè·¯å¾‘æ˜¯æ­£ç¢ºçš„
                const customCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_cards`);
                
                await addDoc(customCollectionRef, {
                    quote: quote,
                    createdAt: new Date().getTime(),
                    isInitialSeed: false 
                });
                
                input.value = '';
                showMessage("è‡ªè¨‚ä½³å¥å„²å­˜æˆåŠŸï¼å·²åŠ å…¥æŠ½å¡åº«ã€‚", 'success');
                // onSnapshot æœƒè‡ªå‹•æ›´æ–°åˆ—è¡¨
            } catch (error) {
                console.error("å„²å­˜è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤å›é¥‹ï¼Œæç¤ºæª¢æŸ¥ Firestore æ¬Šé™
                showMessage(`å„²å­˜è‡ªè¨‚ä½³å¥å¤±æ•—ï¼š${error.message}ã€‚è«‹æª¢æŸ¥ Firestore å¯«å…¥æ¬Šé™ (Security Rules)ã€‚`, 'error');
            } finally {
                saveButton.disabled = false; // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            }
        };

        // åˆªé™¤è‡ªè¨‚ä½³å¥
        window.handleDeleteCustomCard = async (docId) => {
            if (!isAuthReady || !userId || !db) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/custom_cards`, docId);
                await deleteDoc(docRef);
                showMessage("ä½³å¥å·²ç§»é™¤ã€‚", 'info');
            } catch (error) {
                console.error("åˆªé™¤è‡ªè¨‚ä½³å¥å¤±æ•—:", error);
                showMessage("åˆªé™¤è‡ªè¨‚ä½³å¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firestore å®‰å…¨è¦å‰‡ã€‚", 'error');
            }
        };

        // å±•é–‹/æ”¶åˆè‡ªè¨‚ä½³å¥å€å¡Š
        window.toggleCustomCardsSection = () => {
            const section = document.getElementById('customCardsSection');
            const icon = document.getElementById('toggleIcon');
            section.classList.toggle('active');
            if (section.classList.contains('active')) {
                icon.textContent = 'â–²';
            } else {
                icon.textContent = 'â–¼';
            }
        };

        // --- æ­·å²ç´€éŒ„åŠŸèƒ½ (æ–°å¢åˆ†é é‚è¼¯) ---
        
        // è¨­å®šæ­·å²ç´€éŒ„çš„å³æ™‚ç›£è½
        const setupDrawHistoryListener = () => {
            if (!isAuthReady || !userId || !db) return;

            const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/draw_history`);
            
            // ä½¿ç”¨ onSnapshot ç›£è½æ­·å²ç´€éŒ„è®Šæ›´ï¼Œä¸ä½¿ç”¨ orderByï¼Œåœ¨ JS ä¸­æ’åº
            onSnapshot(historyCollectionRef, (snapshot) => {
                const fetchedHistory = [];
                snapshot.forEach(doc => {
                    fetchedHistory.push({ id: doc.id, ...doc.data() });
                });
                
                // æ ¹æ“šæ™‚é–“æˆ³å€’åºæ’åº (æœ€æ–°åœ¨æœ€å‰é¢)
                fetchedHistory.sort((a, b) => b.timestamp - a.timestamp);
                
                allHistoryRecords = fetchedHistory; // æ›´æ–°å…¨åŸŸæ­·å²ç´€éŒ„
                
                // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œä¿æŒç•¶å‰é ç¢¼
                renderDrawHistoryList();
            }, (error) => {
                console.error("ç›£è½æ­·å²ç´€éŒ„å¤±æ•—:", error);
                const historyLoading = document.getElementById('historyLoading');
                if (historyLoading) {
                    historyLoading.textContent = 'è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡ã€‚';
                }
            });
        };
        
        // æ¸²æŸ“æ­·å²ç´€éŒ„åˆ—è¡¨ (åŠ å…¥åˆ†é é‚è¼¯)
        const renderDrawHistoryList = () => {
            const listElement = document.getElementById('historyList');
            const countElement = document.getElementById('historyCount');
            
            if (!listElement) {
                console.error("DOM å…ƒç´  #historyList ä¸å­˜åœ¨ã€‚");
                return;
            }

            listElement.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            
            const totalRecords = allHistoryRecords.length;
            countElement.textContent = `${totalRecords} ç­†ç´€éŒ„`;

            if (totalRecords === 0) {
                listElement.innerHTML = '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰æŠ½å–ç´€éŒ„ã€‚</p>';
                document.getElementById('paginationControls').innerHTML = ''; // æ¸…ç©ºåˆ†é æ§åˆ¶é …
                const historyLoading = document.getElementById('historyLoading');
                if (historyLoading) {
                    historyLoading.classList.add('hidden');
                }
                return;
            }

            // è¨ˆç®—ç•¶å‰é è¦é¡¯ç¤ºçš„è³‡æ–™
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalRecords);
            const recordsToDisplay = allHistoryRecords.slice(startIndex, endIndex);

            recordsToDisplay.forEach(item => {
                const formattedDate = formatTimestamp(item.timestamp);
                
                // ç¢ºä¿å‚³éçµ¦ JavaScript å‡½æ•¸çš„å­—ä¸²è¢«æ­£ç¢ºè½‰ç¾©
                const escapedMessage = item.cardMessage.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const escapedInterpretation = item.geminiInterpretation ? 
                    item.geminiInterpretation.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
                
                const div = document.createElement('div');
                div.className = 'border-b pb-4';
                div.innerHTML = `
                    <div class="flex justify-between items-start p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors cursor-pointer" onclick="toggleHistoryDetails('${item.id}')">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-semibold text-purple-600">${formattedDate}</p>
                            <p class="text-base text-gray-800 truncate">${item.cardMessage}</p>
                            ${item.geminiInterpretation ? 
                                '<span class="inline-flex items-center mt-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">å·²è§£è®€</span>' : 
                                '<span class="inline-flex items-center mt-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">æœªè§£è®€</span>'
                            }
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- æ–°å¢ï¼šé‡æ–°é¡¯ç¤ºè‡³ä¸»å¡ç‰‡æŒ‰éˆ• -->
                            <button onclick="event.stopPropagation(); displayHistoryCard('${escapedMessage}', ${item.cardIndex}, '${escapedInterpretation}')"
                                    title="é‡æ–°é¡¯ç¤ºè‡³ä¸»å¡ç‰‡"
                                    class="p-1 text-green-600 hover:text-green-800 rounded-full transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>

                            <button onclick="event.stopPropagation(); handleDeleteHistory('${item.id}')"
                                    title="åˆªé™¤ç´€éŒ„"
                                    class="p-1 text-red-500 hover:text-red-700 rounded-full transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <span class="text-purple-500 font-bold history-toggle-icon" id="icon-${item.id}">â–¼</span>
                        </div>
                    </div>
                    
                    <div id="details-${item.id}" class="history-item-details pl-3">
                        <div class="p-3 border border-purple-200 bg-white rounded-lg">
                            <h4 class="font-bold text-purple-700 mb-2">æ‡‰ç”¨å»ºè­°ï¼š</h4>
                            <p class="text-sm text-gray-600 whitespace-pre-line">
                                ${item.geminiInterpretation ? item.geminiInterpretation : 'å°šç„¡ AI æ‡‰ç”¨å»ºè­°ï¼Œè«‹åœ¨ä¸»ç•«é¢é‡æ–°æŠ½å–æ­¤å¡å¾Œé»æ“Šã€Œç²å¾—ä»Šæ—¥æ‡‰ç”¨å»ºè­°ã€ä¾†ç”Ÿæˆã€‚'}
                            </p>
                        </div>
                    </div>
                `;
                listElement.appendChild(div);
            });
            
            const historyLoading = document.getElementById('historyLoading');
            if (historyLoading) {
                historyLoading.classList.add('hidden');
            }

            // æ¸²æŸ“åˆ†é æ§åˆ¶é …
            renderPaginationControls(totalRecords);
        };

        // æ¸²æŸ“åˆ†é æ§åˆ¶é …
        const renderPaginationControls = (totalRecords) => {
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';

            const totalPages = Math.ceil(totalRecords / itemsPerPage);
            if (totalPages <= 1) return; // å°‘æ–¼ç­‰æ–¼ä¸€é å‰‡ä¸é¡¯ç¤º

            // ä¸Šä¸€é æŒ‰éˆ•
            controls.innerHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}
                        class="px-3 py-2 text-sm font-medium rounded-lg text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    ä¸Šä¸€é 
                </button>
            `;

            // é ç¢¼æŒ‰éˆ•
            const maxPageButtons = 5; // æœ€å¤šé¡¯ç¤º 5 å€‹é ç¢¼æŒ‰éˆ•
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage ? 'bg-purple-600 text-white shadow-md' : 'bg-white text-gray-700 border border-gray-300 hover:bg-purple-50';
                controls.innerHTML += `
                    <button onclick="changePage(${i})" 
                            class="page-button px-3 py-2 text-sm font-medium rounded-lg ${isActive} transition-colors">
                        ${i}
                    </button>
                `;
            }

            // ä¸‹ä¸€é æŒ‰éˆ•
            controls.innerHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}
                        class="px-3 py-2 text-sm font-medium rounded-lg text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    ä¸‹ä¸€é 
                </button>
            `;
            
            // é¡¯ç¤ºç¸½é æ•¸
            controls.innerHTML += `
                <span class="text-sm text-gray-600 ml-4">ç¬¬ ${currentPage} / ${totalPages} é </span>
            `;
        };

        // æ”¹è®Šç•¶å‰é ç¢¼
        window.changePage = (pageNumber) => {
            const totalPages = Math.ceil(allHistoryRecords.length / itemsPerPage);

            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentPage = pageNumber;
                renderDrawHistoryList();
                // æ²å‹•åˆ°æ­·å²ç´€éŒ„å€å¡Šé ‚éƒ¨
                document.getElementById('historyList').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };


        // å±•é–‹/æ”¶åˆæ­·å²ç´€éŒ„è©³æƒ…
        window.toggleHistoryDetails = (docId) => {
            const details = document.getElementById(`details-${docId}`);
            const icon = document.getElementById(`icon-${docId}`);
            if (details && icon) {
                details.classList.toggle('active');
                if (details.classList.contains('active')) {
                    icon.textContent = 'â–²';
                } else {
                    icon.textContent = 'â–¼';
                }
            }
        };

        // åˆªé™¤æ­·å²ç´€éŒ„
        window.handleDeleteHistory = async (docId) => {
            if (!isAuthReady || !userId || !db) {
                showMessage("ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤ã€‚", 'error');
                return;
            }
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/draw_history`, docId);
                await deleteDoc(docRef);
                showMessage("æ­·å²ç´€éŒ„å·²æˆåŠŸåˆªé™¤ï¼", 'success');
            } catch (error) {
                console.error("åˆªé™¤æ­·å²ç´€éŒ„å¤±æ•—:", error);
                showMessage("åˆªé™¤æ­·å²ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firestore å®‰å…¨è¦å‰‡ã€‚", 'error');
            }
        };


        // è¦–çª—è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– Firebase
        window.onload = initFirebase;
    </script>
</body>
</html>